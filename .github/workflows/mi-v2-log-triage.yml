name: MSI v2 Log Triage

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    # Only run when the issue appears to be MSI v2 related (gating runs inside the script)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: .github/msal-log-triage/package-lock.json

      - name: Install dependencies
        working-directory: .github/msal-log-triage
        run: npm ci

      - name: Fetch issue comments
        id: fetch_comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 5,
            });
            // Return the last 5 comment bodies (skip bot triage comments)
            const bodies = comments
              .filter(c => !c.body.includes('<!-- msal-log-triage:'))
              .slice(-5)
              .map(c => c.body);
            return JSON.stringify(bodies);

      - name: Run log triage analyzer
        id: analyzer
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { analyze } = require('./.github/msal-log-triage/index.js');

            const issueBody = context.payload.issue.body || '';
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            const commentBodiesJson = '${{ steps.fetch_comments.outputs.result }}';
            let commentBodies = [];
            try {
              commentBodies = JSON.parse(commentBodiesJson);
            } catch (_) {}

            const result = analyze({
              issueBody,
              commentBodies,
              labels,
              signaturesPath: './.github/msal-log-triage/signatures.yml',
            });

            if (!result.shouldComment) {
              console.log('Gating: issue is not an MSI v2 issue with MSAL logs. Skipping.');
              core.setOutput('should_comment', 'false');
              return;
            }

            core.setOutput('should_comment', 'true');
            core.setOutput('comment_body', result.comment);
            core.setOutput('stage', result.stage || '');
            core.setOutput('confidence', result.confidence || '');

      - name: Find existing triage comment
        id: find_comment
        if: steps.analyzer.outputs.should_comment == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const marker = '<!-- msal-log-triage:';
            const existing = comments.find(c => c.body.includes(marker));
            return existing ? existing.id : null;

      - name: Post or update triage comment
        if: steps.analyzer.outputs.should_comment == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentBody = `${{ steps.analyzer.outputs.comment_body }}`;
            const existingCommentId = ${{ steps.find_comment.outputs.result }};

            if (existingCommentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingCommentId,
                body: commentBody,
              });
              console.log(`Updated existing triage comment #${existingCommentId}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
              console.log('Created new triage comment');
            }

      - name: Apply MSI v2 stage label
        if: steps.analyzer.outputs.should_comment == 'true' && steps.analyzer.outputs.stage != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const stage = '${{ steps.analyzer.outputs.stage }}';
            // Map stage to label
            const stageToLabel = {
              'MIv2.STS.mTLS.Token': 'mi-v2:mtls',
              'MIv2.IMDS.GetPlatformMetadata': 'mi-v2:imds',
              'MIv2.IMDS.IssueCredential': 'mi-v2:imds',
              'MIv2.MAA.Attestation': 'mi-v2:attestation',
              'MIv2.Cache.ReuseOrMintCert': 'mi-v2:cert-cache',
              'MIv2.KeyGuard.KeyCreation': 'mi-v2:keyguard',
            };
            const label = stageToLabel[stage];
            if (!label) return;

            // Ensure label exists (create if needed)
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
              });
            } catch (e) {
              if (e.status === 404) {
                const colors = {
                  'mi-v2:mtls': 'b60205',
                  'mi-v2:imds': 'e4e669',
                  'mi-v2:attestation': 'd93f0b',
                  'mi-v2:cert-cache': '0075ca',
                  'mi-v2:keyguard': '6f42c1',
                };
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label,
                  color: colors[label] || 'cccccc',
                  description: `MSI v2 triage: ${stage}`,
                });
              }
            }

            // Add label to issue
            const currentLabels = (context.payload.issue.labels || []).map(l => l.name);
            if (!currentLabels.includes(label)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [label],
              });
              console.log(`Applied label: ${label}`);
            }
