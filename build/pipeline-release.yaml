# This Yaml Document has been converted by ESAI Yaml Pipeline Conversion Tool.
# This pipeline will be extended to the OneESPT template
trigger: none
name: $(Date:yyyyMMdd).$(Rev:r)
resources:
    pipelines:
        - pipeline: '_MSALNET-OneBranch-Release-Official'
          project: 'IDDP'
          source: 'MSAL.NET-OneBranch-Release-Official'
    repositories:
        - repository: 1ESPipelineTemplates
          type: git
          name: 1ESPipelineTemplates/1ESPipelineTemplates
          ref: refs/tags/release
extends:
    template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
    parameters:
        pool:
            name: Azure-Pipelines-1ESPT-ExDShared
            image: windows-latest
            os: windows
        customBuildTags:
            - ES365AIMigrationTooling-BulkMigrated-Release
        stages:
            - stage: Stage_1
              displayName: Upload to Nuget
              jobs:
                  - job: PreDeploymentApprovalJob
                    displayName: Pre-Deployment Approval
                    condition: succeeded()
                    timeoutInMinutes: 43200
                    pool: server
                    steps:
                        - task: ManualValidation@1
                          inputs:
                              notifyUsers: |-
                                  avdunn@microsoft.com
                              approvers: |-
                                  avdunn@microsoft.com
                  - job: Job_1
                    displayName: Agentless Job - Approval Service
                    dependsOn: PreDeploymentApprovalJob
                    condition: succeeded()
                    timeoutInMinutes: 7200
                    pool: server
                  - job: Job_2
                    displayName: Agent Job
                    condition: succeeded()
                    timeoutInMinutes: 0
                    templateContext:
                        inputs:
                            - input: pipelineArtifact
                              pipeline: '_MSALNET-OneBranch-Release-Official'
                              artifactName: 'drop_build_main'
                              targetPath: '$(Pipeline.Workspace)/drop_build_main'
                            - input: pipelineArtifact
                              pipeline: '_MSALNET-OneBranch-Release-Official'
                              artifactName: 'drop_build_main_signingLogs1'
                              targetPath: '$(Pipeline.Workspace)/drop_build_main_signingLogs1'
                    steps:
                        - task: NuGetToolInstaller@1
                          displayName: Use NuGet >=5.x
                          inputs:
                              versionSpec: '>=5.x'
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.?.*.*.nupkg
                              nuGetFeedType: external
                              feedPublish: NuGetMsal_NET2
                              externalEndpoint: NuGetMsal_NET2
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL.Desktop'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              solution: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Desktop.?.*.*.nupkg
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Desktop.?.*.*.nupkg
                              nuGetFeedType: external
                              externalEndpoint: NuGetMsal_NET2
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL.Broker'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Broker.?.*.*.nupkg
                              nuGetFeedType: external
                              externalEndpoint: NuGetMsal_NET2
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL Extension'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Extensions.Msal.?.*.*.nupkg
                              nuGetFeedType: external
                              feedPublish: NuGetMsal_NET2
                              externalEndpoint: NuGetMsal_NET2
            - stage: Stage_2
              displayName: Upload to IDDP (VSTS)
              jobs:
                  - job: PreDeploymentApprovalJob
                    displayName: Pre-Deployment Approval
                    condition: succeeded()
                    timeoutInMinutes: 0
                    pool: server
                    steps:
                        - task: ManualValidation@1
                          inputs:
                              notifyUsers: |-
                                  avdunn@microsoft.com
                              approvers: |-
                                  avdunn@microsoft.com
                  - job: Job_1
                    displayName: Agent job
                    dependsOn: PreDeploymentApprovalJob
                    condition: succeeded()
                    timeoutInMinutes: 0
                    templateContext:
                        inputs:
                            - input: pipelineArtifact
                              pipeline: '_MSALNET-OneBranch-Release-Official'
                              artifactName: 'drop_build_main'
                              targetPath: '$(Pipeline.Workspace)/drop_build_main'
                            - input: pipelineArtifact
                              pipeline: '_MSALNET-OneBranch-Release-Official'
                              artifactName: 'drop_build_main_signingLogs1'
                              targetPath: '$(Pipeline.Workspace)/drop_build_main_signingLogs1'
                    steps:
                        - task: NuGetToolInstaller@1
                          displayName: Use NuGet >=5.x
                          inputs:
                              versionSpec: '>=5.x'
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.?.*.*.nupkg
                              feedPublish: 46419298-b96c-437f-bd4c-12c8df7f868d
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL.Client Symbol'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.?.*.*.snupkg
                              feedPublish: 46419298-b96c-437f-bd4c-12c8df7f868d
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL Desktop'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Desktop.?.*.*.nupkg
                              feedPublish: 46419298-b96c-437f-bd4c-12c8df7f868d
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL Desktop Symbol'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Desktop.?.*.*.snupkg
                              feedPublish: 46419298-b96c-437f-bd4c-12c8df7f868d
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL Desktop Broker'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Broker.?.*.*.nupkg
                              feedPublish: 46419298-b96c-437f-bd4c-12c8df7f868d
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL Desktop Broker Symbol'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Broker.?.*.*.snupkg
                              feedPublish: 46419298-b96c-437f-bd4c-12c8df7f868d
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL Extension'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Extensions.Msal.?.*.*.nupkg
                              feedPublish: 46419298-b96c-437f-bd4c-12c8df7f868d
                        - task: 1ES.PublishNuGet@1
                          displayName: 'NuGet Push MSAL Extension Symbol'
                          inputs:
                              packageParentPath: '$(Build.ArtifactStagingDirectory)'
                              packagesToPush: $(System.ArtifactsDirectory)/**/Microsoft.Identity.Client.Extensions.Msal.?.*.*.snupkg
                              feedPublish: 46419298-b96c-437f-bd4c-12c8df7f868d
