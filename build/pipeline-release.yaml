# This Yaml Document has been converted by ESAI Yaml Pipeline Conversion Tool.
# This pipeline will be extended to the OneESPT template
trigger: none
name: $(Date:yyyyMMdd).$(Rev:r)
resources:
  pipelines:
    - pipeline: '_MSALNET-OneBranch-Release-Official'
      project: 'IDDP'
      source: 'MSAL.NET-OneBranch-Release-Official'
  repositories:
    - repository: 1ESPipelineTemplates
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release
extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: MSSecurity-1ES-Build-Agents-Pool
      image: MSSecurity-1ES-Windows-2022
      os: windows
    customBuildTags:
      - ES365AIMigrationTooling-BulkMigrated-Release
    stages:
      - stage: Release_Nuget
        displayName: Upload to Nuget
        condition: eq(variables['Release.Nuget'], 'true') # Only run this stage if set to true at runtime
        # dependsOn: build # Only run if the 'build' stage completes
        jobs:
          - job: Require_Approval
            displayName: Pre-Deployment Approval
            condition: succeeded()
            timeoutInMinutes: 60
            pool: server
            steps:
              - task: ManualValidation@1
                inputs:
                  notifyUsers: |-
                    avdunn@microsoft.com
          - job: Release
            displayName: Release Steps
            dependsOn: Require_Approval # Only run this job if the manual approval job succeeds
            timeoutInMinutes: 0
            templateContext:
              inputs:
                - input: pipelineArtifact
                  pipeline: '_MSALNET-OneBranch-Release-Official'
                  artifactName: 'drop_build_main'
                  targetPath: '$(Build.ArtifactStagingDirectory)/drop_build_main'
            steps:
              - task: NuGetToolInstaller@1
                displayName: Use NuGet >=5.x
                inputs:
                  versionSpec: '>=5.x'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL'
              #   inputs:
              #     command: push
              #     packagesToPush: '$(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.*.nupkg'
              #     nuGetFeedType: external
              #     publishFeedCredentials: 'NuGetMsal_NET2'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL.Desktop'
              #   inputs:
              #     command: push
              #     packagesToPush: '$(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.Desktop.*.nupkg'
              #     nuGetFeedType: external
              #     publishFeedCredentials: 'NuGetMsal_NET2'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL.Broker'
              #   inputs:
              #     command: push
              #     packagesToPush: '$(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.Broker.*.nupkg'
              #     nuGetFeedType: external
              #     publishFeedCredentials: 'NuGetMsal_NET2'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL Extension'
              #   inputs:
              #     command: push
              #     packagesToPush: '$(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.Extensions.Msal.*.nupkg'
              #     nuGetFeedType: external
              #     publishFeedCredentials: 'NuGetMsal_NET2'
      - stage: Release_IDDP
        displayName: Upload to IDDP (VSTS)
        condition: eq(variables['Release.IDDP'], 'true') # Only run this stage if set to true at runtime
        dependsOn: Release_Nuget # Only run if the 'build' stage completes
        jobs:
          - job: Require_Approval
            displayName: Pre-Deployment Approval
            condition: succeeded()
            timeoutInMinutes: 60
            pool: server
            steps:
              - task: ManualValidation@1
                inputs:
                  notifyUsers: |-
                    avdunn@microsoft.com
          - job: Release
            displayName: Release Steps
            dependsOn: Require_Approval # Only run this job if the manual approval job succeeds
            timeoutInMinutes: 0
            templateContext:
              inputs:
                - input: pipelineArtifact
                  pipeline: '_MSALNET-OneBranch-Release-Official'
                  artifactName: 'drop_build_main'
                  targetPath: '$(Build.ArtifactStagingDirectory)/drop_build_main'
                - input: pipelineArtifact
                  pipeline: '_MSALNET-OneBranch-Release-Official'
                  artifactName: 'drop_build_main_signingLogs1'
                  targetPath: '$(Build.ArtifactStagingDirectory)/drop_build_main'
            steps:
              - task: NuGetToolInstaller@1
                displayName: Use NuGet >=5.x
                inputs:
                  versionSpec: '>=5.x'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL'
              #   inputs:
              #     command: push
              #     packagesToPush: $(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.*.nupkg
              #     publishVstsFeed: '46419298-b96c-437f-bd4c-12c8df7f868d'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL.Client Symbol'
              #   inputs:
              #     command: push
              #     packagesToPush: $(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.*.snupkg
              #     publishVstsFeed: '46419298-b96c-437f-bd4c-12c8df7f868d'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL Desktop'
              #   inputs:
              #     command: push
              #     packagesToPush: $(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.Desktop.*.nupkg
              #     publishVstsFeed: '46419298-b96c-437f-bd4c-12c8df7f868d'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL Desktop Symbol'
              #   inputs:
              #     command: push
              #     packagesToPush: $(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.Desktop.*.snupkg
              #     publishVstsFeed: '46419298-b96c-437f-bd4c-12c8df7f868d'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL Desktop Broker'
              #   inputs:
              #     command: push
              #     packagesToPush: $(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.Broker.*.nupkg
              #     publishVstsFeed: '46419298-b96c-437f-bd4c-12c8df7f868d'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL Desktop Broker Symbol'
              #   inputs:
              #     command: push
              #     packagesToPush: $(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.Broker.*.snupkg
              #     publishVstsFeed: '46419298-b96c-437f-bd4c-12c8df7f868d'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL Extension'
              #   inputs:
              #     command: push
              #     packagesToPush: $(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.Extensions.Msal.*.nupkg
              #     publishVstsFeed: '46419298-b96c-437f-bd4c-12c8df7f868d'
              # - task: NuGetCommand@2
              #   displayName: 'NuGet Push MSAL Extension Symbol'
              #   inputs:
              #     command: push
              #     packagesToPush: $(Build.ArtifactStagingDirectory)\drop_build_main\packages\Microsoft.Identity.Client.Extensions.Msal.*.snupkg
              #     publishVstsFeed: '46419298-b96c-437f-bd4c-12c8df7f868d'