# ????????? Managed-Identity E2E on Azure ARC ?????????
# Expected to run on the self-hosted “MSALMSIAZUREARC” pool

parameters:
  dependsOn: []              # allow caller to inject a dependsOn list

jobs:
- job: RunMI_E2E_Arc
  displayName: 'Managed Identity E2E – Azure ARC'
  dependsOn: ${{ parameters.dependsOn }}
  pool:
    name: MSALMSIAZUREARC

  variables:
    runCodesignValidationInjection: false
    Codeql.SkipTaskAutoInjection: true   # disable CodeQL in self-hosted ARC

  steps:
  # 1. Restore
  - task: DotNetCoreCLI@2
    displayName: 'Restore E2E project'
    inputs:
      command: restore
      projects: tests/Microsoft.Identity.Test.E2E.NetCore/Microsoft.Identity.Test.E2E.NetCore.csproj
      arguments: '--framework net8.0 -p:MSBuildEnableWorkloadResolver=false'

  # 2. Build
  - task: DotNetCoreCLI@2
    displayName: 'Build E2E project'
    inputs:
      command: build
      projects: tests/Microsoft.Identity.Test.E2E.NetCore/Microsoft.Identity.Test.E2E.NetCore.csproj
      arguments: '--configuration Release --framework net8.0'

  # 3. Test
  - task: VSTest@2
    displayName: 'Run Managed-Identity E2E (.NET Core)'
    inputs:
      vsTestVersion: '17.0'
      vstestLocation: 'C:\BuildTools\Common7\IDE\Extensions\TestPlatform\vstest.console.exe'
      testSelector: testAssemblies
      testAssemblyVer2: '**/Microsoft.Identity.Test.E2E.NetCore/bin/Release/**/Microsoft.Identity.Test.E2E.NetCore.dll'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      runTestsInIsolation: true
      rerunFailedTests: true
      rerunMaxAttempts: '3'
      runInParallel: false
      codeCoverageEnabled: false
      failOnMinTestsNotRun: true
      minimumExpectedTests: '1'
