# -----------------------------------------------
#  Managed-Identity E2E runner
# -----------------------------------------------
# parameters:
#   name        – display name for the job
#   pool        – agent pool / vmImage
#   runImds     – 'true' to export RUN_IMDS_E2E=true
#   extraSteps  – optional: additional steps (e.g. install MAUI)
# -----------------------------------------------
parameters:
  name: ''
  pool: ''
  runImds: 'false'
  extraSteps: []

jobs:
- job: ${{ parameters.name }}
  displayName: 'Managed Identity E2E – ${{ parameters.name }}'
  dependsOn: ['BuildAndStageProjects']
  pool: ${{ parameters.pool }}

  variables:
    runCodesignValidationInjection: false
    Codeql.SkipTaskAutoInjection: true
    ${{ if eq(parameters.runImds, 'true') }}:
      RUN_IMDS_E2E: 'true'

  steps:
  # ---------- optional caller-supplied steps ----------
  - ${{ each s in parameters.extraSteps }}:
      - ${{ s }}

  # ---------- restore ----------
  - task: DotNetCoreCLI@2
    displayName: 'Restore E2E project'
    inputs:
      command: restore
      projects: tests/Microsoft.Identity.Test.E2E.NetCore/Microsoft.Identity.Test.E2E.NetCore.csproj
      arguments: '--framework net8.0 -p:MSBuildEnableWorkloadResolver=false'

  # ---------- build -------------
  - task: DotNetCoreCLI@2
    displayName: 'Build E2E project'
    inputs:
      command: build
      projects: tests/Microsoft.Identity.Test.E2E.NetCore/Microsoft.Identity.Test.E2E.NetCore.csproj
      arguments: '--configuration Release --framework net8.0'

  # ---------- test --------------
  - task: VSTest@2
    displayName: 'Run Managed Identity E2E'
    inputs:
      #vsTestVersion: '17.0'
      #vstestLocation: 'C:\BuildTools\Common7\IDE\Extensions\TestPlatform\vstest.console.exe'
      testSelector: testAssemblies
      testAssemblyVer2: '**/Microsoft.Identity.Test.E2E.NetCore/bin/Release/**/Microsoft.Identity.Test.E2E.NetCore.dll'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      runTestsInIsolation: true
      rerunFailedTests: true
      rerunMaxAttempts: '3'
      runInParallel: false
      codeCoverageEnabled: false
      failOnMinTestsNotRun: true
      minimumExpectedTests: '1'
