# template-test-on-linux.yaml
# Run all unit tests across the LibsAndSamples.sln project on Linux platform

parameters:
  BuildConfiguration: 'Release'

steps:

- template: template-install-keyvault-secrets.yaml

- task: Bash@3
  displayName: Install broker and depenencies
  inputs:
    targetType: filePath
    filePath: build/linux-install-deps.sh
  condition: succeededOrFailed()

- task: UseDotNet@2
  displayName: 'Use the latest .NET 8'
  inputs:
    version: 8.x

- task: CmdLine@2
  displayName: 'Clear local NuGet cache'
  inputs:
    script: 'nuget locals all -clear'

- task: DotNetCoreCLI@2
  displayName: 'dotnet workload restore'
  inputs:
    command: 'custom'
    custom: 'workload'
    arguments: 'restore .\src\client\Microsoft.Identity.Client\Microsoft.Identity.Client.csproj'

- task: DotNetCoreCLI@2
  displayName: 'Build Integration Test'
  inputs:
    command: 'build'
    projects: |
      # ./tests/Microsoft.Identity.Test.Common/Microsoft.Identity.Test.Common.csproj
      ./tests/Microsoft.Identity.Test.Integration.netcore/Microsoft.Identity.Test.Integration.NetCore.csproj

# - task: MSBuild@1
#   displayName: 'NuGet restore Unit Test'
#   inputs:
#     solution: 'tests/Microsoft.Identity.Test.Unit/Microsoft.Identity.Test.Unit.csproj'
#     msbuildArguments: '/t:restore'
#     configuration: ${{ parameters.BuildConfiguration }}'
#     msBuildVersion: '17.0'

# - task: DownloadPipelineArtifact@0
#   displayName: Download Artifacts from Windows Build
#   inputs:
#     artifactName: drop
#     downloadPath: $(System.DefaultWorkingDirectory)/drop

# VSTest@2 is supported only on Windows 
- script: |
    ls '$(System.DefaultWorkingDirectory)'
    # ls '$(System.DefaultWorkingDirectory)/drop/'
    dotnet test **/Microsoft.Identity.Test.Integration.netcore/bin/**/net8*/Microsoft.Identity.Test.Integration.NetCore.dll --configuration Debug --settings build/CodeCoverage.runsettings
  displayName: 'Run Integration tests .NET'
  env:
    CERTIFICATE_LOCATION: $(generateLabCert.certDir)
    CERTIFICATE_PASSWORD: $(generateLabCert.certPass)