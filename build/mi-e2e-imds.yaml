# ????????? Managed-Identity E2E on Hosted VM / IMDS ?????????
# Exports RUN_IMDS_E2E=true so only the IMDS tests run

parameters:
  dependsOn: []

jobs:
- job: RunMI_E2E_Imds
  displayName: 'Managed Identity E2E – VM / IMDS'
  dependsOn: ${{ parameters.dependsOn }}
  pool:
    vmImage: 'windows-2022'          # Microsoft-hosted Windows agent

  variables:
    RUN_IMDS_E2E: 'true'
    runCodesignValidationInjection: false
    Codeql.SkipTaskAutoInjection: true

  steps:
  # (optional) install MAUI workloads once – remove if your agent already has them
  - task: Bash@3
    displayName: 'Install MAUI workloads (once per agent)'
    inputs:
      targetType: inline
      script: |
        dotnet nuget locals all --clear
        dotnet workload install android ios macos maui

  # 1. Restore
  - task: DotNetCoreCLI@2
    displayName: 'Restore E2E project'
    inputs:
      command: restore
      projects: tests/Microsoft.Identity.Test.E2E.NetCore/Microsoft.Identity.Test.E2E.NetCore.csproj
      arguments: '--framework net8.0 -p:MSBuildEnableWorkloadResolver=false'

  # 2. Build
  - task: DotNetCoreCLI@2
    displayName: 'Build E2E project'
    inputs:
      command: build
      projects: tests/Microsoft.Identity.Test.E2E.NetCore/Microsoft.Identity.Test.E2E.NetCore.csproj
      arguments: '--configuration Release --framework net8.0'

  # 3. Test
  - task: VSTest@2
    displayName: 'Run Managed-Identity E2E (.NET Core)'
    inputs:
      vsTestVersion: '17.0'
      vstestLocation: 'C:\BuildTools\Common7\IDE\Extensions\TestPlatform\vstest.console.exe'
      testSelector: testAssemblies
      testAssemblyVer2: '**/Microsoft.Identity.Test.E2E.NetCore/bin/Release/**/Microsoft.Identity.Test.E2E.NetCore.dll'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      runTestsInIsolation: true
      rerunFailedTests: true
      rerunMaxAttempts: '3'
      runInParallel: false
      codeCoverageEnabled: false
      failOnMinTestsNotRun: true
      minimumExpectedTests: '1'
