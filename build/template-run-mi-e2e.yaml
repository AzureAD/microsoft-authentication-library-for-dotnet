# Runs both Arc and VM/IMDS E2E suites
parameters:
  BuildConfiguration: 'Release'
  TargetFramework:   'net8.0'

jobs:
# ---------- Azure Arc ----------
- job: RunManagedIdentityE2ETestsOnAzureArc
  displayName: 'MI E2E – Azure Arc'
  condition: and(succeeded(), eq(variables['RunMiE2E'], 'true'))
  dependsOn: BuildAndStageProjects
  pool:
    name: 'MSALMSIAZUREARC'
  variables:
    Codeql.SkipTaskAutoInjection: true
  steps:
  - template: template-run-mi-e2e-azurearc.yaml
    parameters:
      BuildConfiguration: ${{ parameters.BuildConfiguration }}
      TargetFramework:   ${{ parameters.TargetFramework }}

# ---------- VM / IMDS ----------
- job: RunManagedIdentityE2ETestsOnImds
  displayName: 'MI E2E – VM / IMDS'
  condition: and(succeeded(), eq(variables['RunMiE2E'], 'true'))
  dependsOn: BuildAndStageProjects
  pool:
    name: 'ID4SMSIHostedAgent'
  variables:
    RUN_IMDS_E2E: 'true'
    MSBuildEnableWorkloadResolver: 'false'
  steps:
  - template: template-run-mi-e2e-imds.yaml
    parameters:
      BuildConfiguration: ${{ parameters.BuildConfiguration }}
      TargetFramework:   ${{ parameters.TargetFramework }}
